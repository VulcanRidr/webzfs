{% extends "layout.jinja" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb Navigation -->
    <nav class="text-sm mb-6 text-text-tertiary">
        <a href="/utils/smart" class="hover:text-blue-400">SMART Monitoring</a> 
        <span class="mx-2">/</span> 
        <a href="/utils/smart/disk/{{ disk_path.lstrip('/') }}" class="hover:text-blue-400">{{ disk_path }}</a>
        <span class="mx-2">/</span> 
        <span class="text-text-primary">Self-Tests</span>
    </nav>

    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-text-primary">SMART Self-Tests: {{ disk_path }}</h1>
        <div class="space-x-2">
            <a href="/utils/smart/disk/{{ disk_path.lstrip('/') }}/tests" class="bg-blue-600 hover:bg-blue-700 text-text-primary px-4 py-2 rounded inline-block">
                üîÑ Refresh
            </a>
            <a href="/utils/smart/disk/{{ disk_path.lstrip('/') }}" class="btn-secondary hover:bg-bg-elevated-2 text-text-primary px-4 py-2 rounded inline-block">
                ‚Üê Back to Disk
            </a>
        </div>
    </div>

    <!-- Success/Error Messages -->
    {% if request.query_params.get('message') %}
    <div class="bg-success-900/30 border-2 border-success-500/50 text-success-400 px-4 py-3 rounded mb-4">
        {{ request.query_params.get('message') }}
    </div>
    {% endif %}
    
    {% if request.query_params.get('error') %}
    <div class="bg-danger-900/30 border-2 border-danger-500/50 text-danger-400 px-4 py-3 rounded mb-4">
        <strong>Error:</strong> {{ request.query_params.get('error') }}
    </div>
    {% endif %}

    <!-- Running Test Status -->
    {% if test_status.running_test %}
    <div class="bg-yellow-900 border border-yellow-700 rounded-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-yellow-300 mb-4"><svg class="w-5 h-5 inline text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                    </svg> Test In Progress</h2>
        <div class="text-yellow-200">
            <p class="mb-2">{{ test_status.running_test.info }}</p>
            <div class="mt-4">
                <div class="flex items-center">
                    <div class="flex-1 bg-yellow-950 rounded-full h-4 mr-4">
                        <div class="bg-yellow-500 h-4 rounded-full" style="width: {{ test_status.running_test.progress }}%"></div>
                    </div>
                    <span class="text-xl font-bold">{{ test_status.running_test.progress }}%</span>
                </div>
            </div>
            <div class="mt-4">
                <form method="post" action="/utils/smart/disk/{{ disk_path.lstrip('/') }}/test/abort" class="inline" id="form-abort-test">
                    <button type="button" 
                            class="bg-red-600 hover:bg-red-700 text-text-primary px-4 py-2 rounded"
                            onclick="showConfirm('modal-abort-test')">
                        Abort Test
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Start New Test -->
    <div class="bg-bg-elevated rounded-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-text-primary mb-4">Start New Test</h2>
        <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[300px]">
                <div class="bg-bg-elevated-2 p-4 rounded">
                    <h3 class="text-lg font-semibold text-text-primary mb-2">Short Test</h3>
                    <p class="text-text-secondary text-sm mb-4">
                        Quick test (typically 1-2 minutes) that checks electrical and mechanical performance 
                        and reads a portion of the disk surface.
                    </p>
                    <form method="post" action="/utils/smart/disk/{{ disk_path.lstrip('/') }}/test/short" id="form-short-test">
                        <button type="button" 
                                class="bg-blue-600 hover:bg-blue-700 text-text-primary px-6 py-2 rounded w-full"
                                onclick="showConfirm('modal-short-test')">
                            Start Short Test
                        </button>
                    </form>
                </div>
            </div>
            <div class="flex-1 min-w-[300px]">
                <div class="bg-bg-elevated-2 p-4 rounded">
                    <h3 class="text-lg font-semibold text-text-primary mb-2">Long Test</h3>
                    <p class="text-text-secondary text-sm mb-4">
                        Comprehensive test (can take several hours) that reads the entire disk surface 
                        and performs additional diagnostic tests.
                    </p>
                    <form method="post" action="/utils/smart/disk/{{ disk_path.lstrip('/') }}/test/long" id="form-long-test">
                        <button type="button" 
                                class="bg-green-600 hover:bg-green-700 text-text-primary px-6 py-2 rounded w-full"
                                onclick="showConfirm('modal-long-test')">
                            Start Long Test
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Test History -->
    <div class="bg-bg-elevated rounded-lg overflow-hidden shadow-lg">
        <div class="p-6 border-b border-gray-700">
            <h2 class="text-xl font-bold text-text-primary">Test History</h2>
        </div>
        
        {% if test_status.test_history and test_status.test_history|length > 0 %}
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-bg-elevated-2 text-text-secondary">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">#</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Test Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Remaining</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Lifetime Hours</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">LBA of Error</th>
                    </tr>
                </thead>
                <tbody class="bg-bg-elevated divide-y divide-border-subtle">
                    {% for test in test_status.test_history %}
                    <tr class="hover:bg-bg-elevated-2 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-text-secondary font-mono">{{ test.num }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-text-primary">{{ test.description }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if 'Completed' in test.status %}
                            <span class="badge badge-success">
                                {{ test.status }}
                            </span>
                            {% elif 'Interrupted' in test.status or 'Aborted' in test.status %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-900 text-orange-300">
                                {{ test.status }}
                            </span>
                            {% elif 'Failed' in test.status %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-900 text-red-300">
                                {{ test.status }}
                            </span>
                            {% else %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-bg-elevated-2 text-text-secondary">
                                {{ test.status }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-text-secondary">{{ test.remaining }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-text-secondary font-mono">{{ test.lifetime }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-text-secondary font-mono">{{ test.lba_of_error }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-8 text-center text-text-tertiary">
            <p>No test history available. Run a test to see results here.</p>
        </div>
        {% endif %}
    </div>

    <!-- Info Box -->
    <div class="mt-6 bg-info-900/30 border-2 border-info-500/50 text-info-400 px-4 py-3 rounded">
        <strong><svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg> About SMART Self-Tests:</strong>
        <ul class="mt-2 text-sm list-disc list-inside space-y-1">
            <li><strong>Short Test:</strong> Quick diagnostic that tests basic drive functionality</li>
            <li><strong>Long Test:</strong> Comprehensive test that reads the entire disk surface</li>
            <li>Tests run in the background and can be interrupted by disk activity</li>
            <li>Regular testing helps detect problems before they cause data loss</li>
            <li>Long tests should be run periodically (monthly recommended)</li>
        </ul>
    </div>
</div>

<!-- Confirmation Modals -->
{% set modal_id = 'modal-abort-test' %}
{% set modal_title = 'Abort Test' %}
{% set modal_message = 'Abort running test on ' + disk_path + '?' %}
{% set confirm_text = 'Abort' %}
{% set confirm_class = 'danger' %}
{% set action_url = '/smart/disk/' + disk_path.lstrip('/') + '/test/abort' %}
{% set method = 'post' %}
{% include 'partials/confirm.jinja' %}

{% set modal_id = 'modal-short-test' %}
{% set modal_title = 'Start Short Test' %}
{% set modal_message = 'Start short test on ' + disk_path + '?' %}
{% set confirm_text = 'Start' %}
{% set confirm_class = 'primary' %}
{% set action_url = '/smart/disk/' + disk_path.lstrip('/') + '/test/short' %}
{% set method = 'post' %}
{% include 'partials/confirm.jinja' %}

{% set modal_id = 'modal-long-test' %}
{% set modal_title = 'Start Long Test' %}
{% set modal_message = 'Start long test on ' + disk_path + '? This may take several hours.' %}
{% set confirm_text = 'Start' %}
{% set confirm_class = 'primary' %}
{% set action_url = '/smart/disk/' + disk_path.lstrip('/') + '/test/long' %}
{% set method = 'post' %}
{% include 'partials/confirm.jinja' %}
{% endblock %}
