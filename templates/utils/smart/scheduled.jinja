{% extends "layout.jinja" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb Navigation -->
    <nav class="text-sm mb-6 text-text-tertiary">
        <a href="/utils/smart" class="hover:text-blue-400">SMART Monitoring</a> 
        <span class="mx-2">/</span> 
        <span class="text-text-primary">Scheduled Tests</span>
    </nav>

    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-text-primary">Scheduled SMART Tests</h1>
        <a href="/utils/smart" class="btn-secondary hover:bg-bg-elevated-2 text-text-primary px-4 py-2 rounded inline-block">
            ‚Üê Back to Disks
        </a>
    </div>

    <!-- Success/Error Messages -->
    {% if request.query_params.get('message') %}
    <div class="bg-success-900/30 border-2 border-success-500/50 text-success-400 px-4 py-3 rounded mb-4">
        {{ request.query_params.get('message') }}
    </div>
    {% endif %}
    
    {% if request.query_params.get('error') %}
    <div class="bg-danger-900/30 border-2 border-danger-500/50 text-danger-400 px-4 py-3 rounded mb-4">
        <strong>Error:</strong> {{ request.query_params.get('error') }}
    </div>
    {% endif %}

    {% if error %}
    <div class="bg-danger-900/30 border-2 border-danger-500/50 text-danger-400 px-4 py-3 rounded mb-4">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <!-- Create New Schedule Form -->
    <div class="bg-bg-elevated rounded-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-text-primary mb-4">Create Scheduled Test</h2>
        <form method="post" action="/utils/smart/scheduled/create" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-text-secondary text-sm font-semibold mb-2">Disk</label>
                    <select name="disk" required class="w-full bg-bg-elevated-2 text-text-primary rounded px-3 py-2 border border-gray-600 focus:border-blue-500 focus:outline-none">
                        <option value="">Select a disk...</option>
                        {% for disk in disks %}
                        <option value="{{ disk.path }}">{{ disk.path }} - {{ disk.model }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-text-secondary text-sm font-semibold mb-2">Test Type</label>
                    <select name="test_type" required class="w-full bg-bg-elevated-2 text-text-primary rounded px-3 py-2 border border-gray-600 focus:border-blue-500 focus:outline-none">
                        <option value="short">Short Test</option>
                        <option value="long">Long Test</option>
                    </select>
                </div>
                <div>
                    <label class="block text-text-secondary text-sm font-semibold mb-2">Schedule (Cron Format)</label>
                    <input type="text" name="schedule" required placeholder="0 2 * * *" 
                           class="w-full bg-bg-elevated-2 text-text-primary rounded px-3 py-2 border border-gray-600 focus:border-blue-500 focus:outline-none">
                    <p class="text-text-tertiary text-xs mt-1">Example: "0 2 * * *" = Daily at 2am</p>
                </div>
            </div>
            <div class="flex items-center">
                <input type="checkbox" name="enabled" id="enabled" value="true" checked class="mr-2">
                <label for="enabled" class="text-text-secondary text-sm">Enabled</label>
            </div>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-text-primary px-6 py-2 rounded font-semibold">
                ‚ûï Create Schedule
            </button>
        </form>
    </div>

    <!-- Scheduled Tests List -->
    {% if scheduled_tests and scheduled_tests|length > 0 %}
    <div class="bg-bg-elevated rounded-lg overflow-hidden shadow-lg">
        <div class="p-6 border-b border-gray-700">
            <h2 class="text-xl font-bold text-text-primary">Active Schedules</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-bg-elevated-2 text-text-secondary">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Disk</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Test Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Schedule</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-bg-elevated divide-y divide-border-subtle">
                    {% for schedule in scheduled_tests %}
                    <tr class="hover:bg-bg-elevated-2 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-text-primary font-mono">{{ schedule.disk }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded {% if schedule.test_type == 'short' %}bg-blue-900 text-blue-300{% else %}bg-purple-900 text-purple-300{% endif %}">
                                {{ schedule.test_type|upper }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-text-secondary font-mono text-sm">{{ schedule.schedule }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if schedule.enabled %}
                            <span class="badge badge-success">
                                Enabled
                            </span>
                            {% else %}
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-bg-elevated-2 text-text-tertiary">
                                Disabled
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-text-tertiary text-sm">{{ schedule.created_at[:10] }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <div class="flex space-x-2">
                                <form method="post" action="/utils/smart/scheduled/{{ schedule.id }}/toggle" class="inline">
                                    <button type="submit" 
                                            class="text-yellow-400 hover:text-yellow-300" 
                                            title="Toggle Enabled/Disabled">
                                        {% if schedule.enabled %}‚è∏Ô∏è{% else %}‚ñ∂Ô∏è{% endif %}
                                    </button>
                                </form>
                                <form method="post" action="/utils/smart/scheduled/{{ schedule.id }}/delete" class="inline" id="form-delete-schedule-{{ schedule.id }}">
                                    <button type="button" 
                                            class="text-red-400 hover:text-red-300" 
                                            title="Delete Schedule"
                                            onclick="showConfirm('modal-delete-schedule-{{ schedule.id }}')">
                                        üóëÔ∏è
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Schedule Count -->
    <div class="mt-4 text-text-tertiary text-sm">
        <p>Total Schedules: {{ scheduled_tests|length }}</p>
    </div>
    {% else %}
    <!-- No Schedules Found -->
    <div class="bg-bg-elevated rounded-lg p-8 text-center">
        <div class="text-text-tertiary mb-4">
            <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <h3 class="text-lg font-medium text-text-primary mb-2">No Scheduled Tests</h3>
        <p class="text-text-tertiary">Create a schedule above to automatically run SMART tests on your disks.</p>
    </div>
    {% endif %}

    <!-- Cron Format Help -->
    <div class="mt-6 bg-info-900/30 border-2 border-info-500/50 text-info-400 px-4 py-3 rounded">
        <strong><svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg> Cron Schedule Format:</strong>
        <div class="mt-2 text-sm">
            <p class="mb-2">Format: <code class="bg-blue-950 px-2 py-1 rounded">minute hour day month weekday</code></p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
                <div>
                    <code class="bg-blue-950 px-2 py-1 rounded">0 2 * * *</code> - Daily at 2:00 AM
                </div>
                <div>
                    <code class="bg-blue-950 px-2 py-1 rounded">0 3 * * 0</code> - Weekly on Sunday at 3:00 AM
                </div>
                <div>
                    <code class="bg-blue-950 px-2 py-1 rounded">0 1 1 * *</code> - Monthly on 1st at 1:00 AM
                </div>
                <div>
                    <code class="bg-blue-950 px-2 py-1 rounded">0 */6 * * *</code> - Every 6 hours
                </div>
            </div>
        </div>
    </div>

    <!-- Important Note -->
    <div class="mt-4 bg-yellow-900 border border-yellow-700 text-yellow-200 px-4 py-3 rounded">
        <strong><svg class="w-5 h-5 inline text-warning-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg> Note:</strong>
        <p class="mt-1 text-sm">
            This interface provides basic scheduling functionality. For production use, consider configuring smartd.conf 
            directly or using system cron jobs. Scheduled tests created here are stored in memory and will be lost on 
            application restart unless persisted to a database.
        </p>
    </div>
</div>

<!-- Confirmation Modals -->
{% if scheduled_tests and scheduled_tests|length > 0 %}
    {% for schedule in scheduled_tests %}
    {% set id = 'modal-delete-schedule-' + schedule.id|string %}
    {% set title = 'Delete Schedule' %}
    {% set message = 'Delete this scheduled test?' %}
    {% set confirm_text = 'Delete' %}
    {% set confirm_class = 'danger' %}
    {% set confirm_action = 'document.getElementById("form-delete-schedule-' + schedule.id|string + '").submit()' %}
    {% include 'partials/confirm.jinja' %}
    {% endfor %}
{% endif %}

<script>
// Wait for Alpine to be ready
document.addEventListener('alpine:init', () => {
    console.log('Alpine.js initialized');
});

// Ensure showConfirm function is available
window.showConfirm = function(dialogId) {
    const dialog = document.getElementById(dialogId);
    
    if (!dialog) {
        console.error('Dialog not found:', dialogId);
        return;
    }
    
    // Try using Alpine's global Alpine object if available
    if (window.Alpine) {
        // Use Alpine.$data to access the component's data
        const component = window.Alpine.$data(dialog);
        if (component) {
            component.open = true;
            return;
        }
    }
    
    // Fallback to __x property
    if (dialog.__x) {
        dialog.__x.$data.open = true;
        return;
    }
    
    // If neither works, try dispatching an event
    dialog.dispatchEvent(new CustomEvent('open-modal'));
    console.warn('Could not open modal using Alpine.js, tried dispatching event');
};
</script>
{% endblock %}
