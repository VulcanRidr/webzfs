{% extends "layout_main.jinja" %}

{% block title %}Add Server - Fleet View - {{ settings.CAPTION }}{% endblock %}

{% block content %}
<div class="container-page py-8 max-w-3xl mx-auto">
  
  {# Breadcrumb Navigation #}
  <nav class="flex mb-6 text-sm" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-2">
      <li>
        <a href="/fleet/" class="text-text-secondary hover:text-primary-400 transition-colors">
          Fleet View
        </a>
      </li>
      <li>
        <svg class="w-4 h-4 text-text-secondary" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
      </li>
      <li>
        <span class="text-text-primary font-medium">Add Server</span>
      </li>
    </ol>
  </nav>

  {# Page Header #}
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-text-primary mb-2 flex items-center">
      <svg class="w-8 h-8 mr-3 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
      </svg>
      Add Remote Server
    </h1>
    <p class="text-text-secondary">Configure a new remote server for ZFS pool monitoring</p>
  </div>

  {# Error Messages #}
  {% if error %}
    {% include "partials/error.jinja" with context %}
  {% endif %}

  {# Add Server Form #}
  <div class="card">
    <div class="card-body">
      <form action="/fleet/servers/add" method="post" class="space-y-6" id="add-server-form">
        
        {# SSH Connection Selection (Recommended) #}
        <div class="card-nested bg-success-500/5 border-success-500/20 mb-6">
          <div class="flex items-start gap-3 mb-4">
            <svg class="w-5 h-5 text-success-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
            </svg>
            <div>
              <h3 class="font-semibold text-success-400 mb-1">Recommended: Use SSH Connection</h3>
              <p class="text-sm text-text-secondary">
                Select from your configured SSH connections for secure key-based authentication.
              </p>
            </div>
          </div>
          
          <div>
            <label for="ssh_connection_id" class="form-label">
              SSH Connection
            </label>
            {% if ssh_connections and ssh_connections|length > 0 %}
            <select id="ssh_connection_id" name="ssh_connection_id" class="form-select">
              <option value="">-- Select an SSH Connection --</option>
              {% for conn in ssh_connections %}
              <option value="{{ conn.id }}" 
                      data-name="{{ conn.name }}"
                      data-host="{{ conn.host }}"
                      data-username="{{ conn.username }}"
                      data-port="{{ conn.port }}">
                {{ conn.name }} ({{ conn.username }}@{{ conn.host }}{% if conn.port != 22 %}:{{ conn.port }}{% endif %})
              </option>
              {% endfor %}
            </select>
            <p class="mt-1 text-sm text-text-secondary">
              Uses secure SSH key-based authentication - no password required
            </p>
            {% else %}
            <div class="bg-warning-900/30 border border-warning-700 text-warning-400 px-4 py-3 rounded-lg">
              <div class="flex items-start">
                <svg class="w-5 h-5 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <div>
                  <p class="font-medium">No SSH connections configured</p>
                  <p class="text-sm mt-1">Configure SSH connections for secure key-based authentication.</p>
                  <a href="/utils/ssh/add" class="btn-warning btn-sm mt-2 inline-flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add SSH Connection
                  </a>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
          
          {# Connection Info Display #}
          <div id="connection-info" class="hidden mt-4 bg-bg-elevated-2 p-3 rounded-lg border border-border-subtle">
            <div class="text-sm grid grid-cols-2 gap-2">
              <div>
                <span class="text-text-tertiary">Name:</span>
                <span id="info-name" class="text-text-primary font-medium ml-2"></span>
              </div>
              <div>
                <span class="text-text-tertiary">Host:</span>
                <span id="info-host" class="text-text-primary font-mono ml-2"></span>
              </div>
              <div>
                <span class="text-text-tertiary">User:</span>
                <span id="info-username" class="text-text-primary font-mono ml-2"></span>
              </div>
              <div>
                <span class="text-text-tertiary">Port:</span>
                <span id="info-port" class="text-text-primary font-mono ml-2"></span>
              </div>
            </div>
          </div>
        </div>

        {# Custom Server Name (optional when using SSH connection) #}
        <div id="custom-name-section">
          <label for="name" class="form-label">
            Server Name <span id="name-required" class="text-danger-400">*</span>
          </label>
          <input 
            type="text" 
            id="name" 
            name="name" 
            class="form-input" 
            value="{{ name if name else '' }}"
            placeholder="e.g., Production Server 1"
          >
          <p id="name-hint" class="mt-1 text-sm text-text-secondary">
            A friendly name to identify this server (defaults to SSH connection name if not provided)
          </p>
        </div>

        {# Manual Entry Section (hidden when SSH connection selected) #}
        <div id="manual-entry-section" class="space-y-6 pt-6 border-t border-border-subtle">
          <div class="flex items-center gap-2 mb-4">
            <svg class="w-5 h-5 text-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            <h3 class="font-medium text-text-secondary">Or Enter Details Manually</h3>
          </div>
          
          {# IP Address #}
          <div>
            <label for="ip" class="form-label">
              IP Address or Hostname <span class="text-danger-400">*</span>
            </label>
            <input 
              type="text" 
              id="ip" 
              name="ip" 
              class="form-input" 
              value="{{ ip if ip else '' }}"
              placeholder="e.g., 192.168.1.100 or server.example.com"
              pattern="^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|[a-zA-Z0-9][a-zA-Z0-9\-\.]*[a-zA-Z0-9])$"
            >
            <p class="mt-1 text-sm text-text-secondary">
              The IP address or hostname of the remote server
            </p>
          </div>

          {# SSH Port #}
          <div>
            <label for="port" class="form-label">
              SSH Port
            </label>
            <input 
              type="number" 
              id="port" 
              name="port" 
              class="form-input" 
              value="{{ port if port else '22' }}"
              min="1"
              max="65535"
              placeholder="22"
            >
            <p class="mt-1 text-sm text-text-secondary">
              SSH port (default is 22)
            </p>
          </div>

          {# Username #}
          <div>
            <label for="username" class="form-label">
              SSH Username <span class="text-danger-400">*</span>
            </label>
            <input 
              type="text" 
              id="username" 
              name="username" 
              class="form-input" 
              value="{{ username if username else '' }}"
              placeholder="e.g., root or zfsadmin"
              autocomplete="off"
            >
            <p class="mt-1 text-sm text-text-secondary">
              Username with permissions to run ZFS commands (typically root)
            </p>
          </div>

          {# Password #}
          <div>
            <label for="password" class="form-label">
              SSH Password <span class="text-danger-400">*</span>
            </label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              class="form-input" 
              placeholder="Enter SSH password"
              autocomplete="new-password"
            >
            <p class="mt-1 text-sm text-text-secondary">
              Password will be encrypted and stored securely. Once saved, it cannot be viewed again.
            </p>
          </div>

          {# Security Note for Manual Entry #}
          <div class="card-nested bg-warning-500/5 border-warning-500/20">
            <div class="flex items-start">
              <svg class="w-5 h-5 text-warning-400 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
              <div class="text-sm">
                <h4 class="font-semibold text-warning-400 mb-1">Security Notice</h4>
                <p class="text-text-secondary">
                  Manual password entry is less secure than SSH key authentication. 
                  Consider using the <a href="/utils/ssh" class="text-primary-400 hover:text-primary-300">SSH Connection Manager</a> instead.
                </p>
              </div>
            </div>
          </div>
        </div>

        {# SSH Requirements Info Box #}
        <div class="card-nested bg-purple-500/5 border-purple-500/20">
          <div class="flex items-start">
            <svg class="w-5 h-5 text-purple-400 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-sm">
              <h4 class="font-semibold text-purple-400 mb-2">SSH Requirements</h4>
              <ul class="list-disc list-inside space-y-1 text-text-secondary">
                <li>Remote server must have SSH enabled and accessible</li>
                <li>User must have permissions to execute <code class="px-1.5 py-0.5 bg-bg-elevated-3 rounded text-xs font-mono">zpool</code> and <code class="px-1.5 py-0.5 bg-bg-elevated-3 rounded text-xs font-mono">zfs</code> commands</li>
                <li>Typically requires root access or a user with ZFS privileges</li>
                <li>Ensure SSH port is not blocked by firewalls</li>
              </ul>
            </div>
          </div>
        </div>

        {# Form Actions #}
        <div class="flex gap-3 pt-4 border-t border-border-subtle">
          <button type="submit" class="btn-primary">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Add Server
          </button>
          <a href="/fleet/" class="btn-secondary">
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>

</div>

<script>
(function() {
    const sshConnectionSelect = document.getElementById('ssh_connection_id');
    const manualEntrySection = document.getElementById('manual-entry-section');
    const connectionInfo = document.getElementById('connection-info');
    const nameInput = document.getElementById('name');
    const nameRequired = document.getElementById('name-required');
    const nameHint = document.getElementById('name-hint');
    const ipInput = document.getElementById('ip');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    
    if (sshConnectionSelect) {
        sshConnectionSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            
            if (this.value) {
                // SSH connection selected - hide manual entry, show connection info
                manualEntrySection.classList.add('hidden');
                connectionInfo.classList.remove('hidden');
                
                // Display connection info
                document.getElementById('info-name').textContent = selectedOption.dataset.name;
                document.getElementById('info-host').textContent = selectedOption.dataset.host;
                document.getElementById('info-username').textContent = selectedOption.dataset.username;
                document.getElementById('info-port').textContent = selectedOption.dataset.port;
                
                // Make manual fields not required
                ipInput.removeAttribute('required');
                usernameInput.removeAttribute('required');
                passwordInput.removeAttribute('required');
                
                // Name is optional when using SSH connection
                nameRequired.classList.add('hidden');
                nameHint.textContent = 'Optional - defaults to SSH connection name if not provided';
                
                // Pre-fill name with connection name if empty
                if (!nameInput.value) {
                    nameInput.placeholder = selectedOption.dataset.name + ' (will use this if left empty)';
                }
            } else {
                // No SSH connection - show manual entry
                manualEntrySection.classList.remove('hidden');
                connectionInfo.classList.add('hidden');
                
                // Make manual fields required
                ipInput.setAttribute('required', '');
                usernameInput.setAttribute('required', '');
                passwordInput.setAttribute('required', '');
                
                // Name is required for manual entry
                nameRequired.classList.remove('hidden');
                nameHint.textContent = 'A friendly name to identify this server';
                nameInput.placeholder = 'e.g., Production Server 1';
            }
        });
        
        // Trigger change on page load
        sshConnectionSelect.dispatchEvent(new Event('change'));
    }
})();
</script>
{% endblock %}
