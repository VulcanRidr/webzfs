{% extends "layout.jinja" %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Breadcrumb Navigation -->
    <nav class="text-sm text-text-secondary mb-4 flex items-center gap-2">
        <a href="/zfs/pools" class="hover:text-text-primary transition-colors">Pools</a>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <a href="/zfs/snapshots" class="hover:text-text-primary transition-colors">Snapshots</a>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <span class="text-text-primary">Sanoid Scheduling</span>
    </nav>

    <!-- Page Header -->
    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">
        <div>
            <h1 class="text-3xl font-bold text-text-primary">Sanoid Automated Snapshots</h1>
            <p class="text-text-secondary mt-2">Manage automated snapshot scheduling and retention policies</p>
        </div>
        <div class="flex gap-2">
            <a href="/zfs/snapshots/sanoid/dataset/add" class="btn-success flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add Dataset
            </a>
            <a href="/zfs/snapshots/sanoid/template/create" class="btn-primary flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Create Policy
            </a>
        </div>
    </div>

    <!-- Success/Error Messages -->
    {% if request.query_params.get('message') %}
    {% with message = request.query_params.get('message') %}
    {% include "partials/success.jinja" %}
    {% endwith %}
    {% endif %}
    
    {% if error %}
    {% include "partials/error.jinja" %}
    {% endif %}

    <!-- Sanoid Status -->
    <div class="card mb-6">
        <h2 class="text-xl font-semibold text-text-primary mb-4 pb-3 border-b border-border-subtle flex items-center gap-2">
            <svg class="w-5 h-5 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Sanoid Status
        </h2>
        {% if status %}
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div class="card-nested">
                <div class="text-text-tertiary text-xs uppercase mb-1">Status</div>
                <div class="text-text-primary font-semibold">
                    {% if status.installed %}
                    <span class="badge-success">Installed</span>
                    {% else %}
                    <span class="badge-danger">Not Installed</span>
                    {% endif %}
                </div>
            </div>
            {% if status.installed %}
            <div class="card-nested">
                <div class="text-text-tertiary text-xs uppercase mb-1">Version</div>
                <div class="text-text-primary font-semibold">{{ status.version or 'Unknown' }}</div>
            </div>
            <div class="card-nested">
                <div class="text-text-tertiary text-xs uppercase mb-1">Configuration</div>
                <div class="text-text-primary font-semibold">
                    {% if status.config_exists %}
                    <span class="badge-success">Found</span>
                    {% else %}
                    <span class="badge-warning">Missing</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-nested">
                <div class="text-text-tertiary text-xs uppercase mb-1">Path</div>
                <div class="text-text-primary text-sm font-mono truncate">{{ status.path }}</div>
            </div>
            {% endif %}
        </div>
        
        {% if status.installed %}
        <div class="flex flex-wrap gap-2">
            <form method="post" action="/zfs/snapshots/sanoid/run" class="inline">
                <input type="hidden" name="take_snapshots" value="true">
                <button type="submit" class="btn-primary flex items-center gap-2 htmx-loading">
                    <span class="htmx-indicator">
                        <div class="loading-spinner loading-spinner-sm"></div>
                    </span>
                    <span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </span>
                    <span>Take Snapshots Now</span>
                </button>
            </form>
            <form method="post" action="/zfs/snapshots/sanoid/run" class="inline" id="form-prune-snapshots">
                <input type="hidden" name="prune_snapshots" value="true">
                <button type="button" class="btn-warning flex items-center gap-2"
                        onclick="showConfirm('modal-prune-snapshots')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Prune Snapshots Now
                </button>
            </form>
            <a href="/zfs/snapshots/sanoid/validate" class="btn-secondary flex items-center gap-2" hx-boost="false">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Validate Config
            </a>
        </div>
        {% endif %}
        {% else %}
        <div class="text-text-tertiary">Unable to determine Sanoid status</div>
        {% endif %}
    </div>

    <!-- Configured Datasets -->
    <div class="card mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-text-primary flex items-center gap-2">
                <svg class="w-5 h-5 text-success-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                </svg>
                Configured Datasets
                <span class="badge-info">{{ datasets|length if datasets else 0 }}</span>
            </h2>
        </div>
        
        {% if datasets %}
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-bg-elevated-2">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Dataset</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Template</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Recursive</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Retention</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-text-secondary uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border-subtle">
                    {% for dataset_name, config in datasets.items() %}
                    <tr class="hover:bg-bg-elevated-2 transition-colors">
                        <td class="px-4 py-3">
                            <a href="/zfs/datasets/{{ dataset_name }}" class="text-primary-400 hover:text-primary-300 font-semibold transition-colors">
                                {{ dataset_name }}
                            </a>
                        </td>
                        <td class="px-4 py-3 text-sm text-text-secondary">
                            {{ config.use_template or '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {% if config.recursive == 'yes' or config.recursive == 'zfs' %}
                            <span class="badge-success">{{ config.recursive }}</span>
                            {% else %}
                            <span class="text-text-tertiary">no</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-xs">
                            <div class="space-y-1">
                                {% if config.hourly and config.hourly != '0' %}<div class="text-info-400">H:{{ config.hourly }}</div>{% endif %}
                                {% if config.daily and config.daily != '0' %}<div class="text-success-400">D:{{ config.daily }}</div>{% endif %}
                                {% if config.weekly and config.weekly != '0' %}<div class="text-warning-400">W:{{ config.weekly }}</div>{% endif %}
                                {% if config.monthly and config.monthly != '0' %}<div class="text-purple-400">M:{{ config.monthly }}</div>{% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end gap-2">
                                <a href="/zfs/snapshots/sanoid/dataset/{{ dataset_name }}/edit" 
                                   class="text-primary-400 hover:text-primary-300 transition-colors" title="Edit">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </a>
                                <form method="post" action="/zfs/snapshots/sanoid/dataset/{{ dataset_name }}/remove" class="inline" id="form-remove-dataset-{{ loop.index }}">
                                    <button type="button" class="text-danger-400 hover:text-danger-300 transition-colors" title="Remove"
                                            onclick="showConfirm('modal-remove-dataset-{{ loop.index }}')">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <svg class="w-16 h-16 text-text-tertiary mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
            </svg>
            <div class="text-text-secondary mb-4">No datasets configured for automated snapshots</div>
            <a href="/zfs/snapshots/sanoid/dataset/add" class="btn-success flex items-center gap-2 inline-flex">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add Your First Dataset
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Available Templates -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-text-primary flex items-center gap-2">
                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Snapshot Policies
                <span class="badge-info">{{ templates|length if templates else 0 }}</span>
            </h2>
        </div>
        
        {% if templates %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for template_name, config in templates.items() %}
            <div class="card-nested">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-text-primary font-semibold">{{ template_name.replace('template_', '') }}</h3>
                    <div class="flex gap-2">
                        <a href="/zfs/snapshots/sanoid/template/{{ template_name }}/edit" 
                           class="text-primary-400 hover:text-primary-300 transition-colors" title="Edit Policy">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </a>
                        <form method="post" action="/zfs/snapshots/sanoid/template/{{ template_name }}/delete" class="inline" id="form-delete-template-{{ loop.index }}">
                            <button type="button" class="text-danger-400 hover:text-danger-300 transition-colors" title="Delete Policy"
                                    onclick="showConfirm('modal-delete-template-{{ loop.index }}')">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
                <div class="space-y-2 text-sm">
                    {% if config.frequently and config.frequently != '0' %}
                    <div class="flex justify-between text-text-secondary">
                        <span>Frequently:</span>
                        <span class="font-semibold text-info-400">{{ config.frequently }}</span>
                    </div>
                    {% endif %}
                    {% if config.hourly and config.hourly != '0' %}
                    <div class="flex justify-between text-text-secondary">
                        <span>Hourly:</span>
                        <span class="font-semibold text-info-400">{{ config.hourly }}</span>
                    </div>
                    {% endif %}
                    {% if config.daily and config.daily != '0' %}
                    <div class="flex justify-between text-text-secondary">
                        <span>Daily:</span>
                        <span class="font-semibold text-success-400">{{ config.daily }}</span>
                    </div>
                    {% endif %}
                    {% if config.weekly and config.weekly != '0' %}
                    <div class="flex justify-between text-text-secondary">
                        <span>Weekly:</span>
                        <span class="font-semibold text-warning-400">{{ config.weekly }}</span>
                    </div>
                    {% endif %}
                    {% if config.monthly and config.monthly != '0' %}
                    <div class="flex justify-between text-text-secondary">
                        <span>Monthly:</span>
                        <span class="font-semibold text-purple-400">{{ config.monthly }}</span>
                    </div>
                    {% endif %}
                    {% if config.yearly and config.yearly != '0' %}
                    <div class="flex justify-between text-text-secondary">
                        <span>Yearly:</span>
                        <span class="font-semibold text-primary-400">{{ config.yearly }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between text-text-tertiary text-xs mt-3 pt-2 border-t border-border-subtle">
                        <span>Auto-snap:</span>
                        <span>{{ config.autosnap or 'yes' }}</span>
                    </div>
                    <div class="flex justify-between text-text-tertiary text-xs">
                        <span>Auto-prune:</span>
                        <span>{{ config.autoprune or 'yes' }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-text-tertiary">
            No templates defined
        </div>
        {% endif %}
    </div>

    <!-- Information -->
    <div class="mt-6 card-nested bg-info-900/20 border-info-900">
        <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-info-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="text-sm">
                <strong class="text-info-400">About Sanoid:</strong>
                <span class="text-text-secondary">Sanoid is a policy-driven snapshot management tool that automatically creates 
                and prunes ZFS snapshots according to defined retention policies. It runs via cron and ensures consistent, 
                automated backup protection for your datasets.</span>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modals -->
{% set id = 'modal-prune-snapshots' %}
{% set title = 'Prune Snapshots' %}
{% set message = 'This will prune old snapshots according to policy. Continue?' %}
{% set confirm_text = 'Prune' %}
{% set confirm_class = 'warning' %}
{% set confirm_action = 'document.getElementById("form-prune-snapshots").submit()' %}
{% include 'partials/confirm.jinja' %}

{% if datasets %}
    {% for dataset_name, config in datasets.items() %}
    {% set id = 'modal-remove-dataset-' + loop.index|string %}
    {% set title = 'Remove Dataset' %}
    {% set message = 'Remove ' + dataset_name + ' from Sanoid configuration?' %}
    {% set confirm_text = 'Remove' %}
    {% set confirm_class = 'danger' %}
    {% set confirm_action = 'document.getElementById("form-remove-dataset-' + loop.index|string + '").submit()' %}
    {% include 'partials/confirm.jinja' %}
    {% endfor %}
{% endif %}

{% if templates %}
    {% for template_name, config in templates.items() %}
    {% set id = 'modal-delete-template-' + loop.index|string %}
    {% set title = 'Delete Policy' %}
    {% set message = 'Delete policy "' + template_name.replace('template_', '') + '"? Datasets using this policy will need to be reconfigured.' %}
    {% set confirm_text = 'Delete' %}
    {% set confirm_class = 'danger' %}
    {% set confirm_action = 'document.getElementById("form-delete-template-' + loop.index|string + '").submit()' %}
    {% include 'partials/confirm.jinja' %}
    {% endfor %}
{% endif %}

<script>
// Wait for Alpine to be ready
document.addEventListener('alpine:init', () => {
    console.log('Alpine.js initialized');
});

// Ensure showConfirm function is available
window.showConfirm = function(dialogId) {
    const dialog = document.getElementById(dialogId);
    
    if (!dialog) {
        console.error('Dialog not found:', dialogId);
        return;
    }
    
    // Try using Alpine's global Alpine object if available
    if (window.Alpine) {
        // Use Alpine.$data to access the component's data
        const component = window.Alpine.$data(dialog);
        if (component) {
            component.open = true;
            return;
        }
    }
    
    // Fallback to __x property
    if (dialog.__x) {
        dialog.__x.$data.open = true;
        return;
    }
    
    // If neither works, try dispatching an event
    dialog.dispatchEvent(new CustomEvent('open-modal'));
    console.warn('Could not open modal using Alpine.js, tried dispatching event');
};
</script>
{% endblock %}
