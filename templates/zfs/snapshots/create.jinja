{% extends "layout.jinja" %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Breadcrumb Navigation -->
    <nav class="flex items-center text-sm text-text-secondary">
        <a href="/zfs/pools" class="hover:text-text-primary transition-colors">Pools</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <a href="/zfs/snapshots" class="hover:text-text-primary transition-colors">Snapshots</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span class="text-text-primary font-medium">Create</span>
    </nav>

    <!-- Page Header -->
    <div>
        <h1 class="text-3xl font-bold text-text-primary">Create Snapshot</h1>
        <p class="text-text-secondary mt-1">Create a point-in-time snapshot of a ZFS dataset</p>
    </div>

    <!-- Error Message -->
    {% if error %}
        {% with message=error %}
            {% include "partials/error.jinja" %}
        {% endwith %}
    {% endif %}

    <!-- Info Box -->
    <div class="card-nested bg-info-900/20 border-info-700">
        <p class="text-sm text-text-secondary inline-flex items-start gap-2">
            <svg class="w-4 h-4 text-info-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>
                <strong>Info:</strong> Snapshots are read-only, point-in-time copies of datasets. They consume no space initially, 
                but will grow as the dataset changes. Snapshots can be used for backups, rollback, and cloning.
            </span>
        </p>
    </div>

    <!-- Create Form -->
    <div class="card">
        <div class="p-6">
            <form method="post" action="/zfs/snapshots/create" class="space-y-6"
                  hx-post="/zfs/snapshots/create"
                  hx-target="body"
                  hx-swap="outerHTML"
                  hx-push-url="true">
                <!-- Dataset Name -->
                <div>
                    <label for="dataset_name" class="form-label">
                        Dataset Name <span class="text-danger-400">*</span>
                    </label>
                    {% if datasets and datasets|length > 0 %}
                    <select 
                        id="dataset_name" 
                        name="dataset_name" 
                        required
                        class="form-select w-full"
                    >
                        <option value="">-- Select a Dataset --</option>
                        {% for ds in datasets %}
                        <option value="{{ ds.name }}" {% if dataset == ds.name %}selected{% endif %}>
                            {{ ds.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-text-tertiary text-xs mt-1">
                        Select the dataset to create a snapshot of
                    </p>
                    {% else %}
                    <div class="card-nested bg-warning-900/20 border-warning-700">
                        <p class="text-sm text-warning-400 inline-flex items-start gap-2">
                            <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <span>
                                <strong>Warning:</strong> No datasets found. Please create a dataset first before creating snapshots.
                            </span>
                        </p>
                    </div>
                    {% endif %}
                </div>

                <!-- Snapshot Name -->
                <div>
                    <label for="snapshot_name" class="form-label">
                        Snapshot Name <span class="text-danger-400">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="snapshot_name" 
                        name="snapshot_name" 
                        value="{{ snapshot_name or default_snapshot_name or '' }}"
                        required
                        placeholder="manual-2025-11-16_23-00"
                        pattern="[a-zA-Z0-9_.\-]+"
                        class="form-input w-full"
                        hx-post="/zfs/snapshots/validate-name"
                        hx-trigger="blur, keyup delay:500ms changed"
                        hx-target="#snapshot-name-validation"
                        hx-include="[name='dataset_name']"
                    >
                    <div id="snapshot-name-validation">
                        <p class="text-text-tertiary text-xs mt-1">
                            The name for the snapshot (without @ symbol). Default format: manual-YYYY-MM-DD_HH-MM
                        </p>
                    </div>
                </div>

                <!-- Recursive Option -->
                <div>
                    <label class="flex items-start cursor-pointer">
                        <input 
                            type="checkbox" 
                            name="recursive" 
                            value="true"
                            {% if recursive %}checked{% endif %}
                            class="form-checkbox mt-0.5"
                        >
                        <span class="ml-2">
                            <span class="text-sm text-text-primary font-medium block">Create recursive snapshot</span>
                            <span class="text-text-tertiary text-xs block mt-0.5">
                                If checked, snapshots will be created for this dataset and all of its children (descendant datasets)
                            </span>
                        </span>
                    </label>
                </div>

                <!-- Example -->
                <div class="card-nested">
                    <h3 class="text-sm font-semibold text-text-primary mb-2 inline-flex items-center gap-2">
                        <svg class="w-4 h-4 text-success-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Example
                    </h3>
                    <p class="text-xs text-text-secondary mb-2">
                        If you create a snapshot named "backup-2025" for dataset "tank/data", the full snapshot name will be:
                    </p>
                    <code class="block bg-bg-elevated-3 text-success-400 text-sm p-2 rounded font-mono">tank/data@backup-2025</code>
                    <p class="text-xs text-text-secondary mt-3 mb-1">
                        With recursive enabled, it will also create snapshots like:
                    </p>
                    <code class="block bg-bg-elevated-3 text-success-400 text-sm p-2 rounded font-mono mb-1">tank/data/documents@backup-2025</code>
                    <code class="block bg-bg-elevated-3 text-success-400 text-sm p-2 rounded font-mono">tank/data/media@backup-2025</code>
                </div>

                <!-- Common Naming Conventions -->
                <div class="card-nested">
                    <h3 class="text-sm font-semibold text-text-primary mb-3 inline-flex items-center gap-2">
                        <svg class="w-4 h-4 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        Common Naming Conventions
                    </h3>
                    <ul class="text-xs text-text-secondary space-y-1.5">
                        <li class="flex items-start gap-2">
                            <span class="text-text-tertiary mt-0.5">•</span>
                            <span><strong class="text-success-400">Date-based:</strong> backup-2025-11-16, snapshot-20251116</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-text-tertiary mt-0.5">•</span>
                            <span><strong class="text-success-400">Frequency-based:</strong> daily-20251116, hourly-2300, weekly-47</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-text-tertiary mt-0.5">•</span>
                            <span><strong class="text-success-400">Purpose-based:</strong> pre-upgrade, before-migration, monthly-backup</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-text-tertiary mt-0.5">•</span>
                            <span><strong class="text-success-400">Automated (Sanoid):</strong> autosnap_2025-11-16_23:00:00_hourly</span>
                        </li>
                    </ul>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button 
                        type="submit"
                        class="btn-success inline-flex items-center justify-center gap-2 htmx-loading"
                    >
                        <span class="htmx-indicator">
                            <div class="loading-spinner loading-spinner-sm"></div>
                        </span>
                        <span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </span>
                        <span>Create Snapshot</span>
                    </button>
                    <a 
                        href="/zfs/snapshots" 
                        class="btn-secondary inline-flex items-center justify-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Additional Information -->
    <div class="card-nested">
        <h3 class="text-sm font-semibold text-text-primary mb-3 inline-flex items-center gap-2">
            <svg class="w-4 h-4 text-info-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            About Snapshots
        </h3>
        <ul class="text-xs text-text-secondary space-y-2">
            <li class="flex items-start gap-2">
                <svg class="w-3 h-3 text-primary-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span>Snapshots are read-only and cannot be modified</span>
            </li>
            <li class="flex items-start gap-2">
                <svg class="w-3 h-3 text-primary-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span>Initial snapshots consume no additional space</span>
            </li>
            <li class="flex items-start gap-2">
                <svg class="w-3 h-3 text-primary-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span>Space usage grows as the parent dataset diverges from the snapshot</span>
            </li>
            <li class="flex items-start gap-2">
                <svg class="w-3 h-3 text-primary-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span>Snapshots can be cloned to create new writable datasets</span>
            </li>
            <li class="flex items-start gap-2">
                <svg class="w-3 h-3 text-primary-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span>Use snapshots for backup, rollback, and disaster recovery</span>
            </li>
            <li class="flex items-start gap-2">
                <svg class="w-3 h-3 text-primary-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span>Consider using <a href="/zfs/snapshots/sanoid" class="text-primary-400 hover:text-primary-300 transition-colors">Sanoid</a> for automated snapshot management</span>
            </li>
        </ul>
    </div>
</div>
{% endblock %}
