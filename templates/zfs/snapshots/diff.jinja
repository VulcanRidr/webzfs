{% extends "layout.jinja" %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Breadcrumb Navigation -->
    <nav class="text-sm text-text-secondary mb-4 flex items-center gap-2">
        <a href="/zfs/pools" class="hover:text-text-primary transition-colors">Pools</a>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <a href="/zfs/snapshots" class="hover:text-text-primary transition-colors">Snapshots</a>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <span class="text-text-primary">Diff</span>
    </nav>

    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-text-primary">Compare Snapshots</h1>
        <p class="text-text-secondary mt-2">View differences between snapshots or snapshot and current state</p>
    </div>

    <!-- Error Message -->
    {% if error %}
    <div class="alert-danger mb-6" role="alert">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="w-5 h-5 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="flex-1 ml-3">
                <h3 class="text-sm font-semibold text-danger-400">Error</h3>
                <div class="mt-1 text-sm text-danger-300">
                    <pre class="whitespace-pre-wrap font-mono text-xs">{{ error }}</pre>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Info Box -->
    <div class="card-nested bg-info-900/20 border-info-900 mb-6">
        <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-info-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="text-sm">
                <strong class="text-info-400">About Snapshot Diff:</strong>
                <span class="text-text-secondary">The diff operation shows what has changed in files and directories between 
                two points in time. This is useful for auditing changes, troubleshooting issues, or understanding what will be lost during a rollback.</span>
            </div>
        </div>
    </div>

    <!-- Diff Form -->
    <div class="card">
        <form method="post" action="/zfs/snapshots/diff" id="diffForm">
            <!-- Dataset Filter -->
            <div class="mb-6">
                <label for="dataset_filter" class="form-label">
                    Filter by Dataset <span class="text-text-tertiary">(Optional)</span>
                </label>
                <select 
                    id="dataset_filter" 
                    class="form-select"
                    onchange="filterSnapshots()"
                >
                    <option value="">-- All Datasets --</option>
                    {% if snapshots %}
                        {% set datasets = snapshots|map(attribute='dataset')|unique|list %}
                        {% for ds in datasets %}
                        <option value="{{ ds }}">{{ ds }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
                <p class="text-text-tertiary text-xs mt-1">
                    Filter snapshots by dataset to make selection easier
                </p>
            </div>

            <!-- First Snapshot -->
            <div class="mb-6">
                <label for="snapshot1" class="form-label">
                    First Snapshot (Earlier) <span class="text-danger-400">*</span>
                </label>
                {% if snapshots and snapshots|length > 0 %}
                <select 
                    id="snapshot1" 
                    name="snapshot1" 
                    required
                    class="form-select"
                >
                    <option value="">-- Select First Snapshot --</option>
                    {% for snap in snapshots %}
                    <option value="{{ snap.name }}" data-dataset="{{ snap.dataset }}" {% if snapshot1 == snap.name %}selected{% endif %}>
                        {{ snap.name }} ({{ snap.creation }})
                    </option>
                    {% endfor %}
                </select>
                <p class="text-text-tertiary text-xs mt-1">
                    Select the older/earlier snapshot for comparison
                </p>
                {% else %}
                <div class="card-nested bg-warning-900/20 border-warning-900">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-warning-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <div class="text-sm">
                            <strong class="text-warning-400">Warning:</strong>
                            <span class="text-text-secondary">No snapshots found.</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Second Snapshot (Optional) -->
            <div class="mb-6">
                <label for="snapshot2" class="form-label">
                    Second Snapshot (Later) <span class="text-text-tertiary">(Optional)</span>
                </label>
                {% if snapshots and snapshots|length > 0 %}
                <select 
                    id="snapshot2" 
                    name="snapshot2"
                    class="form-select"
                >
                    <option value="">-- Current State (no second snapshot) --</option>
                    {% for snap in snapshots %}
                    <option value="{{ snap.name }}" data-dataset="{{ snap.dataset }}">
                        {{ snap.name }} ({{ snap.creation }})
                    </option>
                    {% endfor %}
                </select>
                <p class="text-text-tertiary text-xs mt-1">
                    Leave empty to compare with the current state of the dataset
                </p>
                {% endif %}
            </div>

            <!-- Comparison Modes -->
            <div class="card-nested mb-6">
                <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Comparison Modes
                </h3>
                <div class="space-y-3 text-xs">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-info-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                        </svg>
                        <div>
                            <strong class="text-text-primary">Snapshot to Snapshot:</strong>
                            <p class="text-text-secondary">Compare two specific snapshots to see what changed between them.</p>
                            <p class="text-text-tertiary italic mt-1">Both fields must be filled.</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-success-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                        <div>
                            <strong class="text-text-primary">Snapshot to Current:</strong>
                            <p class="text-text-secondary">Compare a snapshot to the current state of the dataset to see what has changed since.</p>
                            <p class="text-text-tertiary italic mt-1">Leave second snapshot empty.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Example Usage -->
            <div class="card-nested mb-6">
                <h3 class="text-sm font-semibold text-text-primary mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    Example Usage
                </h3>
                <div class="space-y-2 text-xs">
                    <div>
                        <strong class="text-success-400">Pre-upgrade Check:</strong>
                        <p class="text-text-secondary">Compare a pre-upgrade snapshot with current state to see what the upgrade changed.</p>
                    </div>
                    <div>
                        <strong class="text-success-400">Audit Changes:</strong>
                        <p class="text-text-secondary">See what files were added, modified, or deleted during a specific time period.</p>
                    </div>
                    <div>
                        <strong class="text-success-400">Rollback Preview:</strong>
                        <p class="text-text-secondary">Before rolling back, check what you'll lose by comparing snapshot with current.</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button 
                    type="button"
                    onclick="showCompareWarning()"
                    class="btn-primary flex items-center gap-2"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Compare Snapshots
                </button>
                <a 
                    href="/zfs/snapshots" 
                    class="btn-secondary flex items-center gap-2"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Cancel
                </a>
            </div>
        </form>
    </div>

    <!-- Notification Modal -->
    <div id="compareWarningToast" class="fixed inset-0 z-50 hidden pointer-events-none">
        <!-- Modal Container -->
        <div class="fixed inset-0 overflow-y-auto pointer-events-none">
            <div class="flex min-h-full items-center justify-center p-4 pointer-events-none">
                <!-- Modal Content -->
                <div class="card max-w-md w-full transform transition-all pointer-events-auto shadow-2xl">
                    <!-- Header -->
                    <div class="flex items-center justify-between p-6 border-b border-border-default">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-warning-900/30 flex items-center justify-center">
                                <svg class="h-6 w-6 text-warning-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-text-primary">
                                Comparison Notice
                            </h3>
                        </div>
                        <button 
                            type="button"
                            onclick="closeWarningModal()"
                            class="text-text-secondary hover:text-text-primary transition-colors rounded-lg p-1.5"
                            aria-label="Close"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Body -->
                    <div class="p-6">
                        <p class="text-sm text-text-secondary mb-4">
                            Comparing snapshots may take a long time depending on:
                        </p>
                        <ul class="text-sm text-text-secondary space-y-2 mb-4 ml-6 list-disc">
                            <li>Size of the snapshots</li>
                            <li>Number of changed files</li>
                            <li>System performance</li>
                        </ul>
                        <div class="card-nested bg-warning-900/20 border-warning-900 mb-4">
                            <p class="text-sm text-warning-400 font-medium">
                                Please be patient while the comparison is being performed.
                            </p>
                        </div>
                        <div class="flex items-center justify-center gap-2 text-sm">
                            <span class="text-text-tertiary">Auto-starting in</span>
                            <span id="countdownTimer" class="font-bold text-primary-400 text-lg">5</span>
                            <span class="text-text-tertiary">seconds...</span>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="flex items-center justify-end gap-3 px-6 py-4 bg-bg-elevated-2 border-t border-border-default">
                        <button 
                            type="button"
                            onclick="closeWarningModal()"
                            class="btn-secondary"
                        >
                            Cancel
                        </button>
                        <button 
                            type="button"
                            onclick="proceedWithComparison()"
                            class="btn-primary"
                        >
                            OK, Continue
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Understanding Diff Output -->
    <div class="mt-6 card-nested bg-primary-900/20 border-primary-900">
        <h3 class="text-sm font-semibold text-primary-400 mb-3 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            Understanding Diff Output
        </h3>
        <div class="text-xs text-text-secondary space-y-2">
            <p>The diff output uses symbols to indicate the type of change:</p>
            <ul class="space-y-1.5 ml-4">
                <li class="flex items-center gap-2">
                    <code class="px-2 py-0.5 bg-success-900/50 text-success-400 rounded font-mono">+</code>
                    <span>File or directory was <strong class="text-text-primary">added</strong></span>
                </li>
                <li class="flex items-center gap-2">
                    <code class="px-2 py-0.5 bg-warning-900/50 text-warning-400 rounded font-mono">M</code>
                    <span>File was <strong class="text-text-primary">modified</strong></span>
                </li>
                <li class="flex items-center gap-2">
                    <code class="px-2 py-0.5 bg-danger-900/50 text-danger-400 rounded font-mono">-</code>
                    <span>File or directory was <strong class="text-text-primary">removed</strong></span>
                </li>
                <li class="flex items-center gap-2">
                    <code class="px-2 py-0.5 bg-info-900/50 text-info-400 rounded font-mono">R</code>
                    <span>File or directory was <strong class="text-text-primary">renamed</strong></span>
                </li>
            </ul>
            <p class="mt-3">Each line shows: <code class="text-text-primary bg-bg-elevated-2 px-2 py-0.5 rounded">&lt;change type&gt; &lt;file path&gt;</code></p>
        </div>
    </div>
</div>

<script>
// Filter snapshots by dataset
function filterSnapshots() {
    const filterValue = document.getElementById('dataset_filter').value;
    const snapshot1Select = document.getElementById('snapshot1');
    const snapshot2Select = document.getElementById('snapshot2');
    
    // Filter first snapshot dropdown
    for (let option of snapshot1Select.options) {
        if (option.value === '') continue; // Skip placeholder
        const dataset = option.getAttribute('data-dataset');
        if (filterValue === '' || dataset === filterValue) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    }
    
    // Filter second snapshot dropdown
    for (let option of snapshot2Select.options) {
        if (option.value === '') continue; // Skip placeholder
        const dataset = option.getAttribute('data-dataset');
        if (filterValue === '' || dataset === filterValue) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    }
    
    // Reset selections if current selection is now hidden
    const selected1 = snapshot1Select.options[snapshot1Select.selectedIndex];
    if (selected1 && selected1.style.display === 'none') {
        snapshot1Select.selectedIndex = 0;
    }
    
    const selected2 = snapshot2Select.options[snapshot2Select.selectedIndex];
    if (selected2 && selected2.style.display === 'none') {
        snapshot2Select.selectedIndex = 0;
    }
    
    // Also filter out first snapshot from second dropdown
    filterSecondSnapshot();
}

// Filter out the first snapshot from the second snapshot dropdown
function filterSecondSnapshot() {
    const snapshot1Select = document.getElementById('snapshot1');
    const snapshot2Select = document.getElementById('snapshot2');
    const selectedSnapshot1 = snapshot1Select.value;
    
    // Show/hide options in second dropdown based on first selection
    for (let option of snapshot2Select.options) {
        if (option.value === '') continue; // Skip "Current State" option
        
        if (option.value === selectedSnapshot1) {
            option.style.display = 'none';
        } else if (option.style.display === 'none') {
            // Check if it should be visible based on dataset filter
            const filterValue = document.getElementById('dataset_filter').value;
            const dataset = option.getAttribute('data-dataset');
            if (filterValue === '' || dataset === filterValue) {
                option.style.display = '';
            }
        }
    }
    
    // If currently selected second snapshot is the same as first, reset it
    if (snapshot2Select.value === selectedSnapshot1) {
        snapshot2Select.selectedIndex = 0;
    }
}

// Add event listener when page loads
document.addEventListener('DOMContentLoaded', function() {
    const snapshot1Select = document.getElementById('snapshot1');
    if (snapshot1Select) {
        snapshot1Select.addEventListener('change', filterSecondSnapshot);
    }
});

// Modal and countdown functionality
let countdownInterval = null;
let timeRemaining = 5;

function showCompareWarning() {
    // Validate form first
    const snapshot1 = document.getElementById('snapshot1').value;
    if (!snapshot1) {
        alert('Please select the first snapshot before comparing.');
        return;
    }
    
    // Show the toast
    const toast = document.getElementById('compareWarningToast');
    toast.classList.remove('hidden');
    
    // Reset and start countdown
    timeRemaining = 5;
    updateCountdownDisplay();
    
    // Clear any existing interval
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    // Start countdown
    countdownInterval = setInterval(function() {
        timeRemaining--;
        updateCountdownDisplay();
        
        if (timeRemaining <= 0) {
            clearInterval(countdownInterval);
            proceedWithComparison();
        }
    }, 1000);
}

function updateCountdownDisplay() {
    const timerElement = document.getElementById('countdownTimer');
    if (timerElement) {
        timerElement.textContent = timeRemaining;
    }
}

function closeWarningModal() {
    const toast = document.getElementById('compareWarningToast');
    toast.classList.add('hidden');
    
    // Clear countdown
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
}

function proceedWithComparison() {
    // Clear countdown
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
    
    // Close toast
    closeWarningModal();
    
    // Submit the form
    document.getElementById('diffForm').submit();
}
</script>
{% endblock %}
