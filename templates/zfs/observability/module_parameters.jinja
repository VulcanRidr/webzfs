{% extends "layout_main.jinja" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-page max-w-6xl">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2">
            <li class="flex items-center">
                <a href="/" class="text-primary-400 hover:text-primary-300 transition-colors">Home</a>
                <svg class="w-4 h-4 mx-2 text-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </li>
            <li class="flex items-center">
                <a href="/zfs/observability" class="text-primary-400 hover:text-primary-300 transition-colors">Observability</a>
                <svg class="w-4 h-4 mx-2 text-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </li>
            <li>
                <span class="text-text-primary font-medium">Module Parameters</span>
            </li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-text-primary mb-2">ZFS Kernel Module Parameters</h1>
            <p class="text-text-secondary">View current ZFS kernel module configuration parameters</p>
        </div>
        <div class="flex gap-2">
            <a href="/zfs/observability/module-parameters/download" 
               class="btn-success flex items-center gap-2"
               hx-boost="false">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Download
            </a>
        </div>
    </div>

    <!-- Error Message -->
    {% if error %}
    <div class="bg-danger-900/30 border-l-4 border-danger-500 text-danger-400 px-4 py-3 rounded mb-6" role="alert">
        <div class="flex items-start">
            <svg class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div><strong class="font-semibold">Error:</strong> {{ error }}</div>
        </div>
    </div>
    {% endif %}

    {% if parameters.get('error') %}
    <div class="bg-warning-900/30 border-l-4 border-warning-500 text-warning-400 px-4 py-3 rounded mb-6" role="alert">
        <div class="flex items-start">
            <svg class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div><strong class="font-semibold">Warning:</strong> {{ parameters.error }}</div>
        </div>
    </div>
    {% else %}
    
    <!-- Warning Banner -->
    <div class="bg-warning-900/30 border-l-4 border-warning-500 p-4 rounded mb-8">
        <div class="flex items-start">
            <svg class="w-6 h-6 text-warning-400 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
                <h3 class="text-sm font-semibold text-warning-400 mb-2">Caution: Expert Knowledge Required</h3>
                <p class="text-sm text-warning-400">Changing ZFS module parameters requires expert knowledge. Incorrect values can cause system instability or data corruption. Always consult the ZFS documentation before making changes.</p>
            </div>
        </div>
    </div>

    <!-- Search Filter -->
    <div class="card mb-8">
        <div class="p-6">
            <label for="paramSearch" class="form-label">
                Search Parameters
                <span id="search-count" class="text-text-tertiary text-sm font-normal ml-2"></span>
            </label>
            <div class="relative">
                <input type="text" 
                    id="paramSearch" 
                    placeholder="Type to filter parameters..." 
                    class="form-input pr-10"
                    hx-trigger="keyup changed delay:300ms"
                    hx-get="/zfs/observability/module-parameters/filter"
                    hx-target="#parametersTableBody"
                    hx-swap="innerHTML"
                    hx-include="[name='search']">
                <div class="absolute right-3 top-1/2 -translate-y-1/2">
                    <svg class="w-5 h-5 text-text-tertiary htmx-indicator" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
            <p class="text-xs text-text-tertiary mt-2">Start typing to filter parameters in real-time</p>
        </div>
    </div>

    <!-- Parameters Table -->
    <div class="card overflow-hidden mb-8">
        <div class="px-6 py-4 border-b border-border-subtle">
            <h2 class="text-xl font-semibold text-text-primary flex items-center gap-2">
                <svg class="w-5 h-5 text-info-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Current Module Parameters
                <span class="text-sm font-normal text-text-secondary ml-2">({{ parameters|length }} total)</span>
            </h2>
        </div>
        
        {% if parameters %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-border-subtle" id="parametersTable">
                <thead class="bg-bg-elevated-2">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Parameter Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Current Value</th>
                    </tr>
                </thead>
                <tbody class="bg-bg-elevated divide-y divide-border-subtle">
                    {% for name, value in parameters.items() %}
                    {% if name != 'error' %}
                    <tr class="hover:bg-bg-elevated-2 transition-colors parameter-row">
                        <td class="px-6 py-4 text-sm font-medium text-text-primary parameter-name">{{ name }}</td>
                        <td class="px-6 py-4 text-sm text-text-secondary font-mono">{{ value }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-12 text-center">
            <svg class="w-16 h-16 mx-auto text-text-tertiary mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <p class="text-text-secondary text-lg mb-2">No module parameters available</p>
            <p class="text-text-tertiary text-sm">ZFS module parameters could not be read</p>
        </div>
        {% endif %}
    </div>

    <!-- Information Box -->
    <div class="card-nested bg-info-900/20 border-info-500/20">
        <h3 class="text-lg font-semibold text-info-400 mb-3 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            About Module Parameters
        </h3>
        <div class="text-sm text-info-400 space-y-3">
            <p><strong>Source:</strong> <code class="bg-gray-900 px-2 py-0.5 rounded">/sys/module/zfs/parameters/</code></p>
            <p>These parameters control various aspects of ZFS behavior at the kernel level. Common parameters include:</p>
            <ul class="list-disc list-inside ml-4 space-y-1.5">
                <li><strong>zfs_arc_max:</strong> Maximum ARC size in bytes</li>
                <li><strong>zfs_arc_min:</strong> Minimum ARC size in bytes</li>
                <li><strong>zfs_txg_timeout:</strong> Transaction group timeout in seconds</li>
                <li><strong>zfs_prefetch_disable:</strong> Disable prefetching (0=enabled, 1=disabled)</li>
            </ul>
            <p class="mt-3"><strong>To modify parameters:</strong> Use <code class="bg-gray-900 px-1.5 py-0.5 rounded">echo value > /sys/module/zfs/parameters/param_name</code> as root.</p>
            <p><strong>Important:</strong> Changes are runtime-only and will not persist across reboots unless added to module configuration files (e.g., <code class="bg-gray-900 px-1.5 py-0.5 rounded">/etc/modprobe.d/zfs.conf</code>).</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Simple search filter for parameters
document.getElementById('paramSearch')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.parameter-row');
    
    rows.forEach(row => {
        const paramName = row.querySelector('.parameter-name').textContent.toLowerCase();
        if (paramName.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
