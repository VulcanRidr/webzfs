{% extends "layout_main.jinja" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-4">
        <ol class="list-none p-0 inline-flex">
            <li class="flex items-center">
                <a href="/" class="text-primary-400 hover:text-primary-300">Home</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </li>
            <li class="flex items-center">
                <a href="/zfs/performance" class="text-primary-400 hover:text-primary-300">Performance</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </li>
            <li>
                <span class="text-text-secondary">ZFS Processes</span>
            </li>
        </ol>
    </nav>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6" x-data="{ autoRefresh: true, refreshInterval: {{ interval }} }" x-init="window.autoRefresh = autoRefresh; window.refreshInterval = refreshInterval">
        <div>
            <h1 class="text-3xl font-bold text-text-primary mb-2">ZFS Processes</h1>
            <p class="text-text-secondary">Monitor ZFS kernel threads and userland processes</p>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm text-text-secondary" id="last-update">Live Monitoring</span>
            
            <select x-model="refreshInterval" 
                    class="form-select text-sm py-1.5"
                    @change="window.location.href = '/zfs/performance/processes?interval=' + refreshInterval">
                <option value="1" {% if interval == 1 %}selected{% endif %}>1s refresh</option>
                <option value="5" {% if interval == 5 %}selected{% endif %}>5s refresh</option>
                <option value="10" {% if interval == 10 %}selected{% endif %}>10s refresh</option>
                <option value="30" {% if interval == 30 %}selected{% endif %}>30s refresh</option>
                <option value="60" {% if interval == 60 %}selected{% endif %}>60s refresh</option>
            </select>
            
            <button @click="autoRefresh = !autoRefresh; window.autoRefresh = autoRefresh" 
                    class="px-4 py-2 transition-colors"
                    :class="autoRefresh ? 'btn-success' : 'btn-secondary'">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <span x-text="autoRefresh ? 'Auto-refresh: ON' : 'Auto-refresh: OFF'"></span>
                </span>
            </button>
            
            <a href="/zfs/performance/processes/download" 
               class="btn-success flex items-center gap-2"
               hx-boost="false">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Download
            </a>
        </div>
    </div>

    {% if error %}
    <div class="bg-danger-900/30 border-2 border-danger-500/50 text-danger-400 px-4 py-3 rounded mb-4">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" 
         x-data
         hx-get="/zfs/performance/processes-summary"
         :hx-trigger="`load, every ${refreshInterval}s[autoRefresh]`"
         hx-swap="innerHTML">
        <div class="bg-bg-elevated rounded-lg shadow p-6">
            <div class="text-sm text-text-secondary mb-1">Total ZFS Processes</div>
            <div class="text-2xl font-bold text-text-primary">{{ processes|length }}</div>
        </div>

        <div class="bg-bg-elevated rounded-lg shadow p-6">
            <div class="text-sm text-text-secondary mb-1">Running Processes</div>
            <div class="text-2xl font-bold text-success-400">
                {{ processes|selectattr('status', 'equalto', 'running')|list|length }}
            </div>
        </div>

        <div class="bg-bg-elevated rounded-lg shadow p-6">
            <div class="text-sm text-text-secondary mb-1">Sleeping Processes</div>
            <div class="text-2xl font-bold text-primary-400">
                {{ processes|selectattr('status', 'equalto', 'sleeping')|list|length }}
            </div>
        </div>
    </div>

    <!-- Processes Table -->
    <div class="bg-bg-elevated rounded-lg shadow">
        <div class="px-6 py-4 border-b border-border-subtle">
            <h2 class="text-xl font-semibold">Process List</h2>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto" 
                 x-data
                 hx-get="/zfs/performance/processes-table"
                 :hx-trigger="`load, every ${refreshInterval}s[autoRefresh]`"
                 hx-swap="innerHTML">
                {% if processes %}
                <table class="min-w-full divide-y divide-border-subtle">
                    <thead class="bg-bg-elevated-2">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">PID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Process Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">User</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">CPU %</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Memory %</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-bg-elevated divide-y divide-border-subtle">
                        {% for proc in processes %}
                        <tr class="hover:bg-bg-elevated-2">
                            <td class="px-4 py-3 text-sm text-text-primary whitespace-nowrap">{{ proc.pid }}</td>
                            <td class="px-4 py-3 text-sm font-medium text-text-primary">{{ proc.name }}</td>
                            <td class="px-4 py-3 text-sm text-text-secondary">{{ proc.username }}</td>
                            <td class="px-4 py-3 text-sm text-text-primary">{{ "%.1f"|format(proc.cpu_percent) }}%</td>
                            <td class="px-4 py-3 text-sm text-text-primary">{{ "%.1f"|format(proc.memory_percent) }}%</td>
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-1 text-xs rounded-full
                                    {% if proc.status == 'running' %}
                                        badge-success
                                    {% elif proc.status == 'sleeping' %}
                                        badge-info
                                    {% else %}
                                        bg-bg-elevated-2 text-text-primary
                                    {% endif %}">
                                    {{ proc.status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-text-secondary text-center py-8">No ZFS processes currently running</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // Global autoRefresh and refreshInterval variables for HTMX conditional triggers
    window.autoRefresh = true;
    window.refreshInterval = {{ interval }};
    
    // Update last refresh time display
    const lastUpdate = document.getElementById('last-update');
    function updateLastRefresh() {
        const now = new Date();
        lastUpdate.textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }
    
    // Update timestamp when HTMX completes a request
    document.body.addEventListener('htmx:afterSwap', updateLastRefresh);
    
    // Initial timestamp
    updateLastRefresh();
</script>
{% endblock %}
