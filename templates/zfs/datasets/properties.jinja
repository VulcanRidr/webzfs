{% extends "layout.jinja" %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Breadcrumb Navigation -->
    <nav class="flex items-center text-sm text-text-secondary">
        <a href="/zfs/pools" class="hover:text-text-primary transition-colors">Pools</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <a href="/zfs/datasets" class="hover:text-text-primary transition-colors">Datasets</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <a href="/zfs/datasets/{{ dataset_name }}" class="hover:text-text-primary transition-colors">{{ dataset_name }}</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span class="text-text-primary font-medium">Properties</span>
    </nav>

    <!-- Page Header -->
    <div class="flex justify-between items-start gap-4">
        <div>
            <h1 class="text-3xl font-bold text-text-primary">Dataset Properties</h1>
            <p class="text-text-secondary mt-1">{{ dataset_name }}</p>
        </div>
        <div class="flex gap-2">
            <a href="/zfs/datasets/{{ dataset_name }}/properties/download" 
               class="btn-success inline-flex items-center gap-2"
               hx-boost="false">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Download
            </a>
            <a href="/zfs/datasets/{{ dataset_name }}" class="btn-secondary inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Dataset
            </a>
        </div>
    </div>

    <!-- Success/Error Messages -->
    {% if request.query_params.get('message') %}
        {% with message=request.query_params.get('message') %}
            {% include "partials/success.jinja" %}
        {% endwith %}
    {% endif %}
    
    {% if request.query_params.get('error') %}
        {% with message=request.query_params.get('error') %}
            {% include "partials/error.jinja" %}
        {% endwith %}
    {% endif %}
    
    {% if error %}
        {% include "partials/error.jinja" %}
    {% endif %}

    <!-- Properties Table -->
    {% if properties %}
    {% set editable_props = ['atime', 'relatime', 'compression', 'dedup', 'checksum', 'copies', 'quota', 'refquota', 'reservation', 'refreservation', 'recordsize', 'sync', 'readonly', 'exec', 'setuid', 'devices', 'snapdir', 'aclmode', 'aclinherit', 'canmount', 'xattr', 'nbmand', 'vscan', 'utf8only', 'normalization', 'casesensitivity', 'primarycache', 'secondarycache', 'logbias', 'redundant_metadata', 'snapdev', 'mountpoint', 'sharenfs', 'sharesmb'] %}
    
    <!-- Define property options -->
    {% set property_options = {
        'atime': ['on', 'off'],
        'relatime': ['on', 'off'],
        'compression': ['off', 'lz4', 'gzip', 'gzip-1', 'gzip-9', 'zstd', 'lzjb'],
        'dedup': ['on', 'off', 'verify', 'sha256', 'sha256,verify'],
        'checksum': ['on', 'off', 'fletcher2', 'fletcher4', 'sha256', 'sha512', 'skein', 'edonr'],
        'copies': ['1', '2', '3'],
        'sync': ['standard', 'always', 'disabled'],
        'readonly': ['on', 'off'],
        'exec': ['on', 'off'],
        'setuid': ['on', 'off'],
        'devices': ['on', 'off'],
        'snapdir': ['hidden', 'visible'],
        'aclmode': ['discard', 'groupmask', 'passthrough', 'restricted'],
        'aclinherit': ['discard', 'noallow', 'restricted', 'passthrough', 'passthrough-x'],
        'canmount': ['on', 'off', 'noauto'],
        'xattr': ['on', 'off', 'sa'],
        'nbmand': ['on', 'off'],
        'vscan': ['on', 'off'],
        'utf8only': ['on', 'off'],
        'primarycache': ['all', 'none', 'metadata'],
        'secondarycache': ['all', 'none', 'metadata'],
        'logbias': ['latency', 'throughput'],
        'redundant_metadata': ['all', 'most'],
        'snapdev': ['hidden', 'visible'],
        'recordsize': ['512', '1K', '2K', '4K', '8K', '16K', '32K', '64K', '128K', '256K', '512K', '1M']
    } %}
    
    <div class="card">
        <div class="p-4 bg-bg-elevated-2 border-b border-border-subtle flex flex-wrap justify-between items-center gap-4">
            <h2 class="text-xl font-semibold text-text-primary">All Properties ({{ properties|length }})</h2>
            <div class="flex items-center gap-4 text-sm">
                <span class="inline-flex items-center gap-1.5 text-text-secondary">
                    <svg class="w-3.5 h-3.5 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Editable
                </span>
                <span class="inline-flex items-center gap-1.5 text-text-secondary">
                    <svg class="w-3.5 h-3.5 text-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    Read-Only
                </span>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-bg-elevated-2">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider w-1/4">Property</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider w-1/3">Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider w-1/6">Source</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider w-1/4">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border-subtle">
                    {% for prop_name, prop_data in properties.items()|sort %}
                    <tr class="hover:bg-bg-elevated-2 transition-colors {% if prop_name in editable_props %}border-l-4 border-primary-500{% else %}border-l-4 border-border-subtle{% endif %}">
                        <!-- Property Name -->
                        <td class="px-6 py-4 text-sm font-medium text-text-primary">
                            <span class="flex items-center gap-1.5">
                                {{ prop_name }}
                                {% if prop_name in editable_props %}
                                <svg class="w-3 h-3 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                {% endif %}
                            </span>
                        </td>
                        
                        <!-- Value -->
                        <td class="px-6 py-4 text-sm {% if prop_name not in editable_props %}text-text-tertiary{% else %}text-text-primary{% endif %} font-mono">
                            {{ prop_data.value }}
                        </td>
                        
                        <!-- Source -->
                        <td class="px-6 py-4 text-sm text-text-secondary">
                            {{ prop_data.source }}
                        </td>
                        
                        <!-- Action -->
                        <td class="px-6 py-4 text-sm">
                            {% if prop_name in editable_props %}
                            <form method="post" action="/zfs/datasets/{{ dataset_name }}/properties/set" id="form-{{ prop_name }}" class="flex items-center gap-2">
                                <input type="hidden" name="property_name" value="{{ prop_name }}">
                                
                                {% if prop_name in property_options %}
                                    <!-- Dropdown for properties with limited options -->
                                    <select name="property_value" id="value-{{ prop_name }}" class="form-select flex-1 text-sm py-1">
                                        {% for option in property_options[prop_name] %}
                                        <option value="{{ option }}" {% if prop_data.value == option %}selected{% endif %}>{{ option }}</option>
                                        {% endfor %}
                                    </select>
                                {% elif prop_name in ['quota', 'refquota', 'reservation', 'refreservation'] %}
                                    <!-- Size inputs -->
                                    <input type="text" 
                                           id="value-{{ prop_name }}"
                                           name="property_value" 
                                           value="{{ prop_data.value }}"
                                           placeholder="e.g., 10G, 500M, 1T, or none"
                                           class="form-input flex-1 text-sm py-1 font-mono">
                                {% elif prop_name in ['mountpoint', 'sharenfs', 'sharesmb'] %}
                                    <!-- Path or share inputs -->
                                    <input type="text" 
                                           id="value-{{ prop_name }}"
                                           name="property_value" 
                                           value="{{ prop_data.value }}"
                                           placeholder="path or none"
                                           class="form-input flex-1 text-sm py-1 font-mono">
                                {% else %}
                                    <!-- Default text input for other editable properties -->
                                    <input type="text" 
                                           id="value-{{ prop_name }}"
                                           name="property_value" 
                                           value="{{ prop_data.value }}"
                                           class="form-input flex-1 text-sm py-1 font-mono">
                                {% endif %}
                                
                                <button type="button" 
                                        class="btn-primary text-xs px-3 py-1 whitespace-nowrap"
                                        onclick="showConfirm('confirm-update-{{ prop_name }}')">
                                    Update
                                </button>
                            </form>
                            {% else %}
                            <span class="text-text-tertiary text-xs italic inline-flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                                Read-only
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Information -->
    <div class="card-nested">
        <h3 class="text-sm font-semibold text-text-primary mb-4 flex items-center gap-2">
            <svg class="w-4 h-4 text-info-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Property Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-xs text-text-secondary">
            <div>
                <p class="font-semibold text-text-primary mb-2">Performance Properties</p>
                <ul class="space-y-1.5">
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">compression:</strong> Data compression algorithm</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">atime:</strong> Access time updates (off = better performance)</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">recordsize:</strong> Block size (128K default)</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">sync:</strong> Synchronous write behavior</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">primarycache:</strong> ARC caching (all/none/metadata)</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">secondarycache:</strong> L2ARC caching</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">logbias:</strong> ZIL behavior (latency/throughput)</span>
                    </li>
                </ul>
            </div>
            <div>
                <p class="font-semibold text-text-primary mb-2">Data Protection</p>
                <ul class="space-y-1.5">
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">checksum:</strong> Data integrity algorithm</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">copies:</strong> Data redundancy (1-3 copies)</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">dedup:</strong> Deduplication (use with caution)</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">readonly:</strong> Read-only mode</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">redundant_metadata:</strong> Metadata redundancy</span>
                    </li>
                </ul>
            </div>
            <div>
                <p class="font-semibold text-text-primary mb-2">Quotas & Access Control</p>
                <ul class="space-y-1.5">
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">quota:</strong> Maximum size limit</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">refquota:</strong> Limit excluding snapshots</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">reservation:</strong> Guaranteed space</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">refreservation:</strong> Guaranteed space excluding snapshots</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">exec:</strong> Allow executable files</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">setuid:</strong> Allow setuid/setgid</span>
                    </li>
                    <li class="flex items-start gap-1.5">
                        <span class="text-text-tertiary mt-0.5">•</span>
                        <span><strong class="text-text-primary">devices:</strong> Allow device nodes</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card text-center py-12">
        <svg class="w-16 h-16 mx-auto text-text-tertiary mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <p class="text-text-secondary">No properties available for this dataset.</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Confirmation Modals for Property Updates -->
{% if properties %}
    {% for prop_name, prop_data in properties.items() %}
        {% if prop_name in editable_props %}
        {% set id = 'confirm-update-' ~ prop_name %}
        {% set title = 'Update Property' %}
        {% set message = 'Update property "' ~ prop_name ~ '" for dataset ' ~ dataset_name ~ '?' %}
        {% set confirm_text = 'Update' %}
        {% set confirm_class = 'primary' %}
        {% set action_url = '' %}
        {% set confirm_action = 'document.getElementById(\'form-' ~ prop_name ~ '\').submit()' %}
        {% include 'partials/confirm.jinja' %}
        {% endif %}
    {% endfor %}
{% endif %}

<script>
// Robust showConfirm function with multiple fallbacks
window.showConfirm = function(dialogId) {
    console.log('showConfirm called with ID:', dialogId);
    const dialog = document.getElementById(dialogId);
    
    if (!dialog) {
        console.error('Dialog not found:', dialogId);
        console.log('Available dialog IDs:', Array.from(document.querySelectorAll('[id^="confirm-"]')).map(el => el.id));
        return;
    }
    
    console.log('Dialog element found:', dialog);
    console.log('Dialog has Alpine __x?', !!dialog.__x);
    console.log('Window has Alpine?', !!window.Alpine);
    
    // Try using Alpine's global Alpine object if available
    if (window.Alpine) {
        // Use Alpine.$data to access the component's data
        const component = window.Alpine.$data(dialog);
        console.log('Got Alpine component:', component);
        if (component) {
            component.open = true;
            console.log('Set component.open = true via Alpine object');
            return;
        }
    }
    
    // Fallback to __x property
    if (dialog.__x) {
        console.log('Using __x property');
        dialog.__x.$data.open = true;
        console.log('Set open = true via __x');
        return;
    }
    
    // If neither works, try dispatching an event
    console.warn('Could not open modal using Alpine.js, trying event dispatch');
    dialog.dispatchEvent(new CustomEvent('open-modal'));
};

// Debug: Log when Alpine is ready
document.addEventListener('alpine:init', () => {
    console.log('Alpine.js initialized');
});

// Debug: Log all modal IDs on page load
document.addEventListener('DOMContentLoaded', () => {
    const modals = document.querySelectorAll('[id^="confirm-"]');
    console.log('Found', modals.length, 'confirmation modals');
    modals.forEach(modal => console.log('Modal ID:', modal.id));
});
</script>
{% endblock %}
