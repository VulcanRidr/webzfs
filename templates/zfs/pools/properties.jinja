{% extends "layout.jinja" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-4">
        <ol class="list-none p-0 inline-flex">
            <li class="flex items-center">
                <a href="/zfs/pools" class="text-blue-400 hover:text-blue-300">Pools</a>
                <span class="mx-2 text-gray-500">/</span>
            </li>
            <li class="flex items-center">
                <a href="/zfs/pools/{{ pool_name }}" class="text-blue-400 hover:text-blue-300">{{ pool_name }}</a>
                <span class="mx-2 text-gray-500">/</span>
            </li>
            <li class="text-gray-300">Properties</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">Pool Properties: {{ pool_name }}</h1>
        <div class="flex gap-2">
            <a href="/zfs/pools/{{ pool_name }}/properties/download" 
               class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded inline-flex items-center gap-2"
               hx-boost="false">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Download
            </a>
            <a href="/zfs/pools/{{ pool_name }}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded inline-block">
                ← Back to Pool
            </a>
        </div>
    </div>

    <!-- Success/Error Messages -->
    {% if request.query_params.get('message') %}
    <div class="bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded mb-4">
        {{ request.query_params.get('message') }}
    </div>
    {% endif %}
    
    {% if request.query_params.get('error') %}
    <div class="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded mb-4">
        <strong>Error:</strong> {{ request.query_params.get('error') }}
    </div>
    {% endif %}

    <!-- Properties Table -->
    {% if properties %}
    {% set editable_props = ['comment', 'readonly', 'ashift', 'autoexpand', 'autoreplace', 'autotrim', 'bootfs', 'cachefile', 'delegation', 'failmode', 'listsnapshots', 'multihost'] %}
    
    <!-- Define property options -->
    {% set property_options = {
        'readonly': ['on', 'off'],
        'autoexpand': ['on', 'off'],
        'autoreplace': ['on', 'off'],
        'autotrim': ['on', 'off'],
        'delegation': ['on', 'off'],
        'listsnapshots': ['on', 'off'],
        'multihost': ['on', 'off'],
        'failmode': ['wait', 'continue', 'panic'],
        'ashift': ['9', '12', '13']
    } %}
    
    <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg">
        <div class="p-4 bg-gray-700 border-b border-gray-600 flex justify-between items-center">
            <h2 class="text-xl font-semibold text-white">All Properties ({{ properties|length }})</h2>
            <div class="text-sm text-gray-400">
                <span class="inline-flex items-center mr-4">
                    <span class="w-3 h-3 bg-blue-600 rounded-full mr-2"></span>
                    Editable
                </span>
                <span class="inline-flex items-center">
                    <span class="w-3 h-3 bg-gray-600 rounded-full mr-2"></span>
                    Read-Only
                </span>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-700 text-gray-300">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-1/4">Property</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-1/3">Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-1/6">Source</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider w-1/4">Action</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
                    {% for prop_name, prop_data in properties.items()|sort %}
                    <tr class="hover:bg-gray-750 transition-colors {% if prop_name in editable_props %}border-l-4 border-blue-600{% else %}border-l-4 border-gray-600{% endif %}">
                        <!-- Property Name -->
                        <td class="px-6 py-4 text-sm font-medium text-gray-300">
                            {{ prop_name }}
                            {% if prop_name in editable_props %}
                            <span class="ml-2 text-xs text-blue-400">✏️</span>
                            {% endif %}
                        </td>
                        
                        <!-- Value -->
                        <td class="px-6 py-4 text-sm {% if prop_name not in editable_props %}text-gray-500{% else %}text-gray-200{% endif %} font-mono">
                            {{ prop_data.value }}
                        </td>
                        
                        <!-- Source -->
                        <td class="px-6 py-4 text-sm text-gray-400">
                            {{ prop_data.source }}
                        </td>
                        
                        <!-- Action -->
                        <td class="px-6 py-4 text-sm">
                            {% if prop_name in editable_props %}
                            <form method="post" action="/zfs/pools/{{ pool_name }}/properties" id="form-{{ prop_name }}" class="flex items-center space-x-2">
                                <input type="hidden" name="property_name" value="{{ prop_name }}">
                                
                                {% if prop_name in property_options %}
                                    <!-- Dropdown for properties with limited options -->
                                    <select name="property_value" 
                                            class="flex-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500">
                                        {% for option in property_options[prop_name] %}
                                        <option value="{{ option }}" {% if prop_data.value == option %}selected{% endif %}>{{ option }}</option>
                                        {% endfor %}
                                    </select>
                                {% elif prop_name == 'comment' %}
                                    <!-- Free text for comment -->
                                    <input type="text" 
                                           name="property_value" 
                                           value="{{ prop_data.value }}"
                                           placeholder="Enter comment..."
                                           class="flex-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500 font-mono">
                                {% elif prop_name == 'bootfs' %}
                                    <!-- Text input for dataset path -->
                                    <input type="text" 
                                           name="property_value" 
                                           value="{{ prop_data.value }}"
                                           placeholder="dataset/path or -"
                                           class="flex-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500 font-mono">
                                {% elif prop_name == 'cachefile' %}
                                    <!-- Text input for file path -->
                                    <input type="text" 
                                           name="property_value" 
                                           value="{{ prop_data.value }}"
                                           placeholder="/path/to/cachefile or none"
                                           class="flex-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500 font-mono">
                                {% else %}
                                    <!-- Default text input for other editable properties -->
                                    <input type="text" 
                                           name="property_value" 
                                           value="{{ prop_data.value }}"
                                           class="flex-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:border-blue-500 font-mono">
                                {% endif %}
                                
                                <button type="button" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs whitespace-nowrap"
                                        onclick="showConfirm('confirm-update-{{ prop_name }}')">
                                    Update
                                </button>
                            </form>
                            {% else %}
                            <span class="text-text-tertiary text-xs italic">Read-only</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Information -->
    <div class="mt-6 bg-gray-800 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-gray-300 mb-2">Property Information:</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs text-gray-400">
            <div>
                <p class="font-medium text-gray-300 mb-1">Common Editable Properties:</p>
                <ul class="space-y-1">
                    <li>• <strong>comment:</strong> User-defined comment (free text)</li>
                    <li>• <strong>readonly:</strong> on | off (pool read-only mode)</li>
                    <li>• <strong>autoexpand:</strong> on | off (automatic expansion)</li>
                    <li>• <strong>autoreplace:</strong> on | off (automatic device replacement)</li>
                    <li>• <strong>autotrim:</strong> on | off (automatic TRIM)</li>
                    <li>• <strong>ashift:</strong> 9 | 12 | 13 (sector size power)</li>
                </ul>
            </div>
            <div>
                <p class="font-medium text-gray-300 mb-1">Advanced Properties:</p>
                <ul class="space-y-1">
                    <li>• <strong>delegation:</strong> on | off (permission delegation)</li>
                    <li>• <strong>failmode:</strong> wait | continue | panic (failure behavior)</li>
                    <li>• <strong>bootfs:</strong> dataset path (bootable dataset)</li>
                    <li>• <strong>cachefile:</strong> file path or none (cache file location)</li>
                    <li>• <strong>multihost:</strong> on | off (multiple host access)</li>
                </ul>
            </div>
        </div>
    </div>
    {% else %}
    <div class="bg-gray-800 rounded-lg p-8 text-center">
        <p class="text-gray-400">No properties available for this pool.</p>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div class="mt-6">
        <a href="/zfs/pools/{{ pool_name }}" class="text-blue-400 hover:text-blue-300">
            ← Back to Pool Details
        </a>
    </div>
</div>

<!-- Confirmation Modals for Property Updates -->
{% if properties %}
    {% for prop_name, prop_data in properties.items() %}
        {% if prop_name in editable_props %}
        {% set id = 'confirm-update-' ~ prop_name %}
        {% set title = 'Update Property' %}
        {% set message = 'Update property "' ~ prop_name ~ '" for pool ' ~ pool_name ~ '?' %}
        {% set confirm_text = 'Update' %}
        {% set confirm_class = 'primary' %}
        {% set action_url = '' %}
        {% set confirm_action = 'document.getElementById(\'form-' ~ prop_name ~ '\').submit()' %}
        {% include 'partials/confirm.jinja' %}
        {% endif %}
    {% endfor %}
{% endif %}

<script>
// Robust showConfirm function with multiple fallbacks
window.showConfirm = function(dialogId) {
    const dialog = document.getElementById(dialogId);
    
    if (!dialog) {
        console.error('Dialog not found:', dialogId);
        console.log('Available dialog IDs:', Array.from(document.querySelectorAll('[id^="confirm-"]')).map(el => el.id));
        return;
    }
    
    // Try using Alpine's global Alpine object if available
    if (window.Alpine) {
        const component = window.Alpine.$data(dialog);
        if (component) {
            component.open = true;
            return;
        }
    }
    
    // Fallback to __x property
    if (dialog.__x) {
        dialog.__x.$data.open = true;
        return;
    }
    
    // If neither works, try dispatching an event
    dialog.dispatchEvent(new CustomEvent('open-modal'));
    console.warn('Could not open modal using Alpine.js, tried dispatching event');
};
</script>
{% endblock %}
